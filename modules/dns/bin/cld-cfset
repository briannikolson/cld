#!/bin/bash
HELP_DESC=$(cat << 'EOL'
CloudFlare settings manager
EOL
)
HELP_ARGS=$(cat << 'EOL'
$1                       DNS zone - FQDN
$2                       CloudFlare setting name
$3                       CloudFlare setting value
EOL
)
HELP_EXAMPLES=$(cat << 'EOL'
cld-cfset example.com email_obfuscation off
cld-cfset example.com server_side_exclude off
cld-cfset example.com ipv6 off
cld-cfset example.com cache_level basic
cld-cfset example.com browser_cache_ttl 0
cld-cfset example.com always_online off
EOL
)
source /var/cld/bin/include/cldfuncs
source /var/cld/modules/dns/bin/include/dnsfuncs
DNS_ZONE=${1,,}
MAIN_ZONE=$(echo $DNS_ZONE | rev | cut -d . -f -2 | rev)
CF_SETTING_NAME="$2"
CF_SETTING_VALUE="$3"

echo "${CF_SETTING_VALUE}" | egrep -q "^([0-9]+|true|false)$" && export CFQUOTE="" || export CFQUOTE='"'

echo $DNS_ZONE | egrep -q "^[a-z0-9.*-]+\.[a-z0-9.-]+$" \
|| echoexit1 "incorrect domain - only full domain names allowed: example.com test.example.com"

#[ $CFACC || CFACC=$(grep -s "${MAIN_ZONE}" /var/cld/modules/dns/data/cf/$(TZ=Europe/Moscow date +%F)/cf_dns_list | head -1 | cut -d _ -f 3)
#[ $CFACC || CFACC=$(grep -s "${MAIN_ZONE}" /var/cld/modules/dns/data/cf/$(TZ=Europe/Moscow date +%F --date=yesterday)/cf_dns_list | head -1 | cut -d _ -f 3)
[ "$CFACC" ] && {
CFAPI=$(grep "$CFACC" /var/cld/creds/creds_dns_cf_api_list | grep -v "^#")
cf-dns-api-creds
CF_ZONE_ID=$(cf-dns-get-zone-id ${MAIN_ZONE})
}
[ "$CFAPI" ] || for CFAPI in $(cat /var/cld/creds/creds_dns_cf_api_list | grep -v "^#")
do
cf-dns-api-creds
CF_ZONE_ID=$(cf-dns-get-zone-id ${MAIN_ZONE})
[ "${CF_ZONE_ID}" ] && break
done

[ "$CF_ZONE_ID" ] || echoexit1 "domain $MAIN_ZONE not found in known accounts"

cf-change-settings ${CF_ZONE_ID} ${CF_SETTING_NAME} ${CF_SETTING_VALUE} | jq .