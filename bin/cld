#!/bin/bash
HELP_DESC=$(cat << 'EOL'
Main ClassicDeploy CLI access system utility
EOL
)
HELP_ARGS=$(cat << 'EOL'
$1                       First PATTERN filtering allowed instances
$2                       Second PATTERN filtering allowed instances
$3                       Third PATTERN filtering allowed instances
--list                   Show filtered instances and exit
--json                   Using together --list to json output
--beauty                 Using together with --list and --json option to beautify json output
--groups=GROUP1,GROUP2   Filtering by instance groups
--debug                  Verbose output of connection
EOL
)
HELP_EXAMPLES=$(cat << 'EOL'
cld #CLI,WEB
cld prod 1.2. #CLI,WEB
cld --groups=gcloud prod --debug #CLI,WEB
cld prod 1.2. --list 
cld prod 1.2. --groups=default --list --json --beauty
EOL
)

source /var/cld/bin/include/cldfuncs

OPTS="$(expr "$@" : '\([A-Za-z0-9 /:.,@_=+^*-]\+\)')"
for i in $OPTS
do
  case $i in                   
    -g=*|-groups=*|--groups=*) printf -v CLD_GROUPS "%q" "${i#*=}" ;;
    -l|-list|--list) LIST=1                                        ;;
    -j|-json|--json) JSON=1                                        ;;
    -b|-beauty|--beauty) JSON_BEAUTY=1                             ;;
    -d|-debug|--debug) VERBOSE=" -v"                               ;;
    -*)                                                            ;;
    *) let ii++; printf -v ARG$ii "%q" "${i}"                      ;;
  esac
done


[ "$JSON" == "1" ] && JSONARG='--json'
[ "$JSON_BEAUTY" == "1" -a "$FROM" == "API" ] && JSON_BEAUTY_ARG='| jq . -C'
[ "$JSON_BEAUTY" == "1" -a "$FROM" != "API" ] && JSON_BEAUTY_ARG='| jq .'

if [ "$LIST" = "1" ] ; then source <(echo -n CLOUDS_USER_ALLOWED --groups="${CLD_GROUPS}" "${JSONARG}" "$ARG1" "$ARG2" "$ARG3" ${JSON_BEAUTY_ARG}) ; exit 0 ; fi

echo "Please select instance to enter"
select VM in $(CLOUDS_USER_ALLOWED --groups="${CLD_GROUPS}" "$ARG1" "$ARG2" "$ARG3")
do
  CLD_LOGS
  if [ "$VM" ]
  then
    INSTANCE_GROUP_FUNCS
    echo "You had chosen ${GROUP} $VM"
    $CLD_VARS
    echo
    $CLD_TERMINAL
  else
    echo "you choosed incorrect instance, please try again and type digits only"
  fi
  break
done